<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Velora - Private Cellar</title>
    
    <!-- Luxury Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Cormorant+Garamond:ital,wght@0,300;0,400;0,600;1,300&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Alpine.js for Sequential Selection -->
    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/cdn.min.js"></script>
    
    <style>
        :root {
            --gold: #D4AF37;
            --gold-dim: #8a702a;
            --bg-dark: #050505;
            --bg-charcoal: #1A1A1A;
        }
        
        body {
            font-family: 'Cormorant Garamond', serif;
            background: linear-gradient(135deg, #050505 0%, #1A1A1A 100%);
            color: #e5e5e5;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        
        .font-cinzel { font-family: 'Cinzel', serif; }
        .gold-text { color: var(--gold); }
        
        /* Wine Cards */
        .wine-card {
            background: linear-gradient(180deg, rgba(30,30,30,0.4) 0%, rgba(10,10,10,0.6) 100%);
            border: 1px solid rgba(212, 175, 55, 0.15);
            backdrop-filter: blur(10px);
            transition: all 0.4s ease-out;
            cursor: pointer;
        }
        
        .wine-card:hover {
            border-color: var(--gold);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(212, 175, 55, 0.2);
        }
        
        .wine-card.selected {
            border-color: var(--gold);
            background: linear-gradient(180deg, rgba(212,175,55,0.1) 0%, rgba(212,175,55,0.05) 100%);
        }
        
        /* Rarity Diamonds */
        .rarity-indicator {
            display: flex;
            gap: 2px;
            font-size: 10px;
        }
        
        .diamond {
            color: #444;
        }
        
        .diamond.filled {
            color: var(--gold);
        }
        
        /* Progress Bar */
        .progress-dot {
            width: 32px;
            height: 4px;
            background: #333;
            border-radius: 2px;
            transition: all 0.3s ease;
        }
        
        .progress-dot.active {
            background: var(--gold);
        }
        
        .progress-dot.completed {
            background: #666;
        }
        
        /* Loading Animation */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        /* Fade Transitions */
        .fade-enter {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="p-4">

    <!-- HEADER -->
    <header class="w-full max-w-md mx-auto text-center py-6 mb-8">
        <h1 class="font-cinzel text-3xl gold-text mb-1 tracking-widest">VELORA</h1>
        <p class="text-[10px] uppercase tracking-[0.4em] text-gray-500">Private Digital Sommelier</p>
    </header>

    <!-- MAIN APP -->
    <main class="w-full max-w-md mx-auto pb-24">
        
        <!-- STEP 1: RESTAURANT SELECTION -->
        <div id="step-restaurant" class="step-view">
            <h2 class="text-2xl text-white mb-8 text-center italic font-light">Where are you dining?</h2>
            
            <select id="restaurant-select" 
                    onchange="selectRestaurant(this.value)"
                    class="w-full bg-gray-900/60 border border-gray-700 text-white p-4 rounded focus:border-gold focus:outline-none">
                <option value="">Choose a restaurant...</option>
            </select>
        </div>

        <!-- STEP 2: MENU SELECTION -->
        <div id="step-menu" class="step-view hidden">
            <div class="mb-6">
                <span class="back-button font-cinzel text-xs text-gray-500 cursor-pointer hover:text-gold" 
                      onclick="goToStep('restaurant')">‚Üê BACK TO RESTAURANTS</span>
            </div>
            
            <div class="flex justify-between items-end mb-6 border-b border-gray-800 pb-4">
                <div>
                    <h2 class="text-2xl text-white" id="menu-title">Menu</h2>
                    <p class="text-xs gold-text uppercase tracking-widest mt-1" id="time-context">Service</p>
                </div>
            </div>
            
            <div id="menu-grid" class="space-y-8"></div>
            
            <div class="fixed bottom-0 left-0 w-full p-6 bg-gradient-to-t from-black via-black to-transparent pointer-events-none">
                <button 
                    onclick="goToStep('preferences')" 
                    id="btn-course" 
                    class="pointer-events-auto w-full bg-[#D4AF37] text-black py-4 font-cinzel font-bold tracking-widest text-xs hover:bg-white transition-all duration-500 opacity-0 transform translate-y-10">
                    CONFIRM SELECTION (<span id="dish-count">0</span>)
                </button>
            </div>
        </div>

        <!-- STEP 3: PREFERENCES -->
        <div id="step-preferences" class="step-view hidden">
            <div class="mb-6">
                <span class="back-button font-cinzel text-xs text-gray-500 cursor-pointer hover:text-gold" 
                      onclick="goToStep('menu')">‚Üê BACK TO MENU</span>
            </div>
            
            <h2 class="text-3xl text-white mb-2 text-center italic font-light">The Cellar</h2>
            <p class="text-center text-gray-500 text-sm mb-12">Tailoring your acquisition.</p>
            
            <div class="space-y-12">
                <!-- BOTTLE COUNT -->
                <div>
                    <label class="font-cinzel text-[0.65rem] tracking-[0.2em] text-[#666] block text-center mb-6">
                        SERVICE SIZE
                    </label>
                    <div class="flex justify-center items-center gap-8">
                        <button onclick="updateBottles(-1)" class="text-2xl text-gray-500 hover:text-white p-2 transition-colors">‚àí</button>
                        <span id="bottle-display" class="text-4xl gold-text font-cinzel">1</span>
                        <button onclick="updateBottles(1)" class="text-2xl text-gray-500 hover:text-white p-2 transition-colors">+</button>
                    </div>
                    <p class="text-center text-xs text-gray-600 mt-2 uppercase tracking-widest">Bottle(s)</p>
                </div>
                
                <!-- BUDGET SLIDER -->
                <div>
                    <label class="font-cinzel text-[0.65rem] tracking-[0.2em] text-[#666] block text-center mb-6">
                        BUDGET TARGET
                    </label>
                    <div class="text-center mb-6">
                        <span class="text-4xl text-white font-cinzel">
                            $<span id="budget-display">1000</span>
                        </span>
                    </div>
                    <input 
                        type="range" 
                        id="budget-slider" 
                        min="150" 
                        max="5000" 
                        step="50" 
                        value="1000" 
                        class="w-full" 
                        oninput="document.getElementById('budget-display').innerText = this.value">
                </div>
            </div>
            
            <button 
                onclick="generateProgression()" 
                class="w-full mt-16 border border-[#D4AF37] text-[#D4AF37] py-4 font-cinzel font-bold tracking-widest text-xs hover:bg-[#D4AF37] hover:text-black transition-all duration-500">
                CONSULT SOMMELIER
            </button>
        </div>

        <!-- STEP 4: SEQUENTIAL WINE SELECTION (Alpine.js) -->
        <div id="step-selection" class="step-view hidden">
            <div class="mb-6">
                <span class="back-button font-cinzel text-xs text-gray-500 cursor-pointer hover:text-gold" 
                      onclick="goToStep('preferences')">‚Üê BACK TO PREFERENCES</span>
            </div>
            
            <!-- Alpine.js Component -->
            <div x-data="wineSelectionApp()" x-init="init()">
                
                <!-- Progress Indicators -->
                <div class="flex justify-center gap-2 mb-8">
                    <template x-for="(course, idx) in courses" :key="idx">
                        <div class="progress-dot" 
                             :class="{
                                 'active': idx === currentIndex,
                                 'completed': selections[idx] !== null
                             }"></div>
                    </template>
                </div>
                
                <!-- Bottle Selection View -->
                <div x-show="!showingSummary" class="fade-enter">
                    <div class="text-center mb-8">
                        <p class="text-xs uppercase tracking-[0.3em] text-gray-500 mb-2">
                            Bottle <span x-text="currentIndex + 1"></span> of <span x-text="courses.length"></span>
                        </p>
                        <h2 class="text-2xl text-white italic mb-1" 
                            x-text="currentCourse ? currentCourse.dishes.join(', ') : ''"></h2>
                        <p class="text-xs text-gray-600">Select your preference</p>
                    </div>
                    
                    <!-- Wine Options -->
                    <div class="space-y-6">
                        <template x-for="(wine, wineIdx) in (currentCourse ? currentCourse.options : [])" :key="wineIdx">
                            <div class="wine-card p-6" 
                                 :class="{'selected': selections[currentIndex] && selections[currentIndex].wine_name === wine.wine_name}"
                                 @click="selectWine(wine)">
                                
                                <!-- Header: Rarity + Price -->
                                <div class="flex justify-between items-start mb-4">
                                    <div class="rarity-indicator">
                                        <template x-for="n in 5" :key="n">
                                            <span class="diamond" 
                                                  :class="{'filled': n <= (wine.rarity_level || 1)}">‚óÜ</span>
                                        </template>
                                    </div>
                                    <div class="text-2xl gold-text font-cinzel" 
                                         x-text="'$' + (wine.price || 0)"></div>
                                </div>
                                
                                <!-- Wine Name & Producer -->
                                <h3 class="text-3xl text-white font-serif italic mb-2" 
                                    x-text="wine.wine_name"></h3>
                                <p class="text-sm text-gray-400 font-cinzel tracking-wider mb-4" 
                                   x-text="wine.producer"></p>
                                
                                <!-- Interesting Fact (V5.0 NEW) -->
                                <div x-show="wine.interesting_fact" class="mb-4 p-4 bg-gray-900/50 rounded border-l-2 border-gold/40">
                                    <p class="text-[10px] uppercase tracking-wider text-gold/70 mb-2">Worth Knowing:</p>
                                    <p class="text-sm text-gray-300 leading-relaxed" 
                                       x-text="wine.interesting_fact"></p>
                                </div>
                                
                                <!-- Pairing Note (if available) -->
                                <div x-show="wine.pairing_note" class="mb-4 text-sm text-gray-400 italic">
                                    <p x-text="wine.pairing_note"></p>
                                </div>
                                
                                <!-- Retail Search Button (V5.0 NEW) -->
                                <div class="mt-4 flex justify-end">
                                    <a :href="'https://www.google.com/search?tbm=shop&q=buy+' + encodeURIComponent(wine.wine_name) + '+750ml+-auction+-bid'" 
                                       target="_blank"
                                       @click.stop
                                       class="text-[10px] text-gray-600 hover:text-gold uppercase tracking-wider border border-gray-800 hover:border-gold px-3 py-1 transition-all">
                                        üîç Check Retail
                                    </a>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Navigation Buttons -->
                    <div class="flex gap-4 mt-8">
                        <button x-show="currentIndex > 0"
                                @click="previousBottle()"
                                class="flex-1 border border-gray-700 text-gray-400 py-3 text-xs uppercase tracking-wider font-cinzel hover:border-gold hover:text-gold transition-all">
                            ‚Üê Previous
                        </button>
                        <button x-show="currentIndex < courses.length - 1 && selections[currentIndex]"
                                @click="nextBottle()"
                                class="flex-1 bg-gold text-black py-3 text-xs uppercase tracking-wider font-cinzel font-bold hover:bg-white transition-all">
                            Next ‚Üí
                        </button>
                        <button x-show="currentIndex === courses.length - 1 && selections[currentIndex]"
                                @click="goToSummary()"
                                class="flex-1 bg-gold text-black py-3 text-xs uppercase tracking-wider font-cinzel font-bold hover:bg-white transition-all">
                            Review ‚Üí
                        </button>
                    </div>
                </div>
                
                <!-- Summary View -->
                <div x-show="showingSummary" class="fade-enter">
                    <div class="text-center mb-12">
                        <h2 class="text-3xl text-white font-cinzel mb-2">Your Collection</h2>
                        <p class="text-sm text-gray-500">Review and confirm your selection</p>
                    </div>
                    
                    <!-- Selected Wines Timeline -->
                    <div class="space-y-8 relative pl-6 border-l border-gray-800 mb-12">
                        <template x-for="(sel, idx) in selections" :key="idx">
                            <div x-show="sel" class="relative">
                                <div class="absolute -left-[29px] top-0 w-3 h-3 rounded-full bg-[#D4AF37]"></div>
                                
                                <div class="bg-gray-900/30 p-6 rounded border border-gray-800">
                                    <p class="text-[10px] uppercase tracking-widest text-gray-500 mb-2">
                                        Bottle <span x-text="idx + 1"></span>
                                    </p>
                                    <h3 class="text-2xl text-white font-serif italic mb-1" 
                                        x-text="sel.wine_name"></h3>
                                    <p class="text-sm text-gray-400 mb-2" 
                                       x-text="sel.producer"></p>
                                    <p class="text-xs text-gray-600 mb-3" 
                                       x-text="courses[idx] ? courses[idx].dishes.join(', ') : ''"></p>
                                    
                                    <div class="flex justify-between items-center pt-3 border-t border-gray-800">
                                        <div class="rarity-indicator">
                                            <template x-for="n in (sel.rarity_level || 1)" :key="n">
                                                <span class="diamond filled">‚óÜ</span>
                                            </template>
                                        </div>
                                        <div>
                                            <span class="text-2xl gold-text font-cinzel" 
                                                  x-text="'$' + (sel.price || 0)"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                    
                    <!-- Total Cost -->
                    <div class="p-6 bg-gold/10 border border-gold/30 rounded mb-6">
                        <div class="flex justify-between items-center">
                            <span class="text-lg text-white font-cinzel">Total Investment</span>
                            <span class="text-3xl gold-text font-cinzel" 
                                  x-text="'$' + totalCost.toFixed(0)"></span>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-4">
                        <button @click="backToSelection()"
                                class="flex-1 border border-gray-700 text-gray-400 py-4 text-xs uppercase tracking-wider font-cinzel hover:border-gold hover:text-gold transition-all">
                            ‚Üê Edit Selection
                        </button>
                        <button @click="confirmSelection()"
                                class="flex-1 bg-gold text-black py-4 font-cinzel font-bold tracking-widest text-xs hover:bg-white transition-all">
                            CONFIRM
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- STEP 5: FINAL CONFIRMATION -->
        <div id="step-final" class="step-view hidden">
            <div class="text-center py-12">
                <div class="text-6xl mb-6">üç∑</div>
                <h2 class="text-3xl text-white font-cinzel mb-4">Selection Confirmed</h2>
                <p class="text-gray-400 mb-8">Your cellar awaits.</p>
                <button onclick="resetApp()" 
                        class="text-gray-600 text-xs hover:text-white uppercase tracking-widest">
                    Start New Consultation
                </button>
            </div>
        </div>

    </main>

    <!-- LOADING OVERLAY (with rotating quotes - V5.0) -->
    <div id="loading-overlay" class="fixed inset-0 bg-black z-50 hidden flex-col items-center justify-center">
        <div class="w-12 h-12 border-t-2 border-b-2 border-[#D4AF37] rounded-full spinner mb-8"></div>
        
        <p class="text-gray-400 text-sm mb-2">Consulting Velora...</p>
        <p class="text-gray-600 text-xs uppercase tracking-widest mb-12">Curating Your Cellar</p>
        
        <!-- Rotating Wine Quotes (V5.0 NEW) -->
        <div class="text-center max-w-xl px-6">
            <p id="quote-text" class="text-lg text-gold/90 italic mb-3 transition-opacity duration-500">
                "Wine is bottled poetry."
            </p>
            <p id="quote-author" class="text-sm text-gold/50 tracking-wider transition-opacity duration-500">
                ‚Äî Robert Louis Stevenson
            </p>
        </div>
    </div>

    <!-- JAVASCRIPT -->
    <script>
        // =================================================================
        // STATE MANAGEMENT
        // =================================================================
        
        const state = {
            restaurants: [],
            selectedRestaurant: null,
            dishes: [],
            bottles: 1,
            budget: 1000,
            progression: null
        };

        // =================================================================
        // LOADING QUOTES SYSTEM (V5.0)
        // =================================================================
        
        const WINE_QUOTES = [
            { text: "Wine is bottled poetry.", author: "Robert Louis Stevenson" },
            { text: "A bottle of wine contains more philosophy than all the books in the world.", author: "Louis Pasteur" },
            { text: "Wine is sunlight, held together by water.", author: "Galileo Galilei" },
            { text: "In wine, there is truth.", author: "Pliny the Elder" },
            { text: "Wine makes every meal an occasion, every table more elegant, every day more civilized.", author: "Andre Simon" },
            { text: "Wine is the most civilized thing in the world.", author: "Ernest Hemingway" },
            { text: "Good wine is a good familiar creature if it be well used.", author: "William Shakespeare" },
            { text: "Age appears to be best in four things: old wood to burn, old wine to drink, old friends to trust.", author: "Francis Bacon" },
            { text: "Wine rejoices the heart of man and joy is the mother of all virtues.", author: "Johann Wolfgang von Goethe" },
            { text: "Great wine requires a mad man to grow the vine, a wise man to watch over it, and a lover to drink it.", author: "Salvador Dal√≠" }
        ];
        
        let quoteInterval = null;
        let currentQuoteIndex = 0;
        
        function startLoadingQuotes() {
            currentQuoteIndex = Math.floor(Math.random() * WINE_QUOTES.length);
            updateQuote();
            
            quoteInterval = setInterval(() => {
                currentQuoteIndex = (currentQuoteIndex + 1) % WINE_QUOTES.length;
                updateQuote();
            }, 3000);
        }
        
        function stopLoadingQuotes() {
            if (quoteInterval) {
                clearInterval(quoteInterval);
                quoteInterval = null;
            }
        }
        
        function updateQuote() {
            const quote = WINE_QUOTES[currentQuoteIndex];
            const textEl = document.getElementById('quote-text');
            const authorEl = document.getElementById('quote-author');
            
            textEl.style.opacity = '0';
            authorEl.style.opacity = '0';
            
            setTimeout(() => {
                textEl.textContent = `"${quote.text}"`;
                authorEl.textContent = `‚Äî ${quote.author}`;
                textEl.style.opacity = '1';
                authorEl.style.opacity = '1';
            }, 300);
        }
        
        // =================================================================
        // ALPINE.JS COMPONENT (V5.0 Sequential Selection)
        // =================================================================
        
        function wineSelectionApp() {
            return {
                courses: [],
                selections: [],
                currentIndex: 0,
                showingSummary: false,
                
                get currentCourse() {
                    return this.courses[this.currentIndex] || null;
                },
                
                get totalCost() {
                    return this.selections
                        .filter(s => s !== null)
                        .reduce((sum, wine) => sum + (wine.price || 0), 0);
                },
                
                init() {
                    // Listen for data from main app
                    window.addEventListener('progression-loaded', (e) => {
                        this.courses = e.detail;
                        this.selections = new Array(this.courses.length).fill(null);
                        this.currentIndex = 0;
                        this.showingSummary = false;
                    });
                },
                
                selectWine(wine) {
                    this.selections[this.currentIndex] = wine;
                    
                    // Auto-advance after short delay
                    setTimeout(() => {
                        if (this.currentIndex < this.courses.length - 1) {
                            this.nextBottle();
                        } else {
                            this.goToSummary();
                        }
                    }, 300);
                },
                
                nextBottle() {
                    if (this.currentIndex < this.courses.length - 1) {
                        this.currentIndex++;
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                },
                
                previousBottle() {
                    if (this.currentIndex > 0) {
                        this.currentIndex--;
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }
                },
                
                goToSummary() {
                    this.showingSummary = true;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },
                
                backToSelection() {
                    this.showingSummary = false;
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                },
                
                confirmSelection() {
                    state.progression = this.selections;
                    goToStep('final');
                }
            };
        }
        
        // =================================================================
        // INITIALIZATION
        // =================================================================
        
        async function init() {
            try {
                const response = await fetch('/restaurants');
                const data = await response.json();
                state.restaurants = data.restaurants || [];
                
                const select = document.getElementById('restaurant-select');
                select.innerHTML = '<option value="">Choose a restaurant...</option>' +
                    state.restaurants.map(r => 
                        `<option value="${r.id}">${r.name} - ${r.cuisine}</option>`
                    ).join('');
            } catch (error) {
                console.error('Failed to load restaurants:', error);
            }
        }
        
        // =================================================================
        // RESTAURANT & MENU
        // =================================================================
        
        async function selectRestaurant(restaurantId) {
            if (!restaurantId) return;
            
            state.selectedRestaurant = restaurantId;
            state.dishes = [];
            
            try {
                const hour = new Date().getHours();
                const context = (hour >= 11 && hour < 16) ? 'lunch' : 'dinner';
                
                const response = await fetch(`/restaurant/${restaurantId}/menu`);
                const data = await response.json();
                
                const menu = data.menus[context] || data.menus['dinner'] || {};
                renderMenu(menu);
                
                goToStep('menu');
            } catch (error) {
                console.error('Failed to load menu:', error);
            }
        }
        
        function renderMenu(menuData) {
            let html = '';
            
            for (const [section, items] of Object.entries(menuData)) {
                if (!Array.isArray(items) || items.length === 0) continue;
                
                html += `
                    <div class="mb-8">
                        <h3 class="text-center text-xs text-[#D4AF37] uppercase tracking-[0.3em] mb-6 border-b border-[#D4AF37]/20 pb-2 mx-12">
                            ${escapeHtml(section)}
                        </h3>
                `;
                
                items.forEach(item => {
                    const safeName = escapeForJs(item.name);
                    html += `
                        <div onclick="toggleDish('${safeName}', this)" 
                             class="relative p-4 mb-2 cursor-pointer group transition-all duration-300 rounded-sm hover:bg-white/5">
                            <div class="flex justify-between items-baseline">
                                <span class="text-lg text-gray-200 font-serif group-hover:text-[#D4AF37] transition-colors">
                                    ${escapeHtml(item.name)}
                                </span>
                                <span class="text-sm text-gray-600 font-cinzel">
                                    $${item.price}
                                </span>
                            </div>
                            <div class="selection-indicator absolute left-0 top-0 bottom-0 w-[2px] bg-[#D4AF37] opacity-0 transition-opacity duration-300"></div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            document.getElementById('menu-grid').innerHTML = html;
        }
        
        function toggleDish(name, element) {
            if (state.dishes.includes(name)) {
                state.dishes = state.dishes.filter(d => d !== name);
                element.querySelector('.selection-indicator').style.opacity = '0';
            } else {
                state.dishes.push(name);
                element.querySelector('.selection-indicator').style.opacity = '1';
            }
            
            const btn = document.getElementById('btn-course');
            const count = document.getElementById('dish-count');
            
            count.innerText = state.dishes.length;
            
            if (state.dishes.length > 0) {
                btn.classList.remove('opacity-0', 'translate-y-10');
            } else {
                btn.classList.add('opacity-0', 'translate-y-10');
            }
        }
        
        // =================================================================
        // PREFERENCES
        // =================================================================
        
        function updateBottles(delta) {
            state.bottles = Math.max(1, Math.min(5, state.bottles + delta));
            document.getElementById('bottle-display').innerText = state.bottles;
        }
        
        // =================================================================
        // PAIRING GENERATION
        // =================================================================
        
        async function generateProgression() {
            const budget = parseInt(document.getElementById('budget-slider').value);
            state.budget = budget;
            
            // Show loading
            showLoading();
            startLoadingQuotes();
            
            try {
                const response = await fetch('/consult/progression', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        dishes: state.dishes,
                        bottle_count: state.bottles,
                        budget: budget
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    state.progression = data.progression;
                    
                    // Notify Alpine.js component
                    window.dispatchEvent(new CustomEvent('progression-loaded', {
                        detail: data.progression
                    }));
                    
                    hideLoading();
                    stopLoadingQuotes();
                    goToStep('selection');
                } else {
                    throw new Error(data.error || 'Pairing generation failed');
                }
            } catch (error) {
                console.error('Error generating progression:', error);
                alert('Unable to generate pairing. Please try again.');
                hideLoading();
                stopLoadingQuotes();
            }
        }
        
        // =================================================================
        // NAVIGATION
        // =================================================================
        
        function goToStep(stepId) {
            document.querySelectorAll('.step-view').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${stepId}`).classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        function showLoading() {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.remove('hidden');
            overlay.classList.add('flex');
        }
        
        function hideLoading() {
            const overlay = document.getElementById('loading-overlay');
            overlay.classList.add('hidden');
            overlay.classList.remove('flex');
        }
        
        function resetApp() {
            state.dishes = [];
            state.bottles = 1;
            state.budget = 1000;
            state.selectedRestaurant = null;
            state.progression = null;
            
            document.getElementById('restaurant-select').value = '';
            document.getElementById('budget-slider').value = 1000;
            document.getElementById('budget-display').innerText = '1000';
            document.getElementById('bottle-display').innerText = '1';
            
            goToStep('restaurant');
        }
        
        // =================================================================
        // UTILITY FUNCTIONS
        // =================================================================
        
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function escapeForJs(text) {
            if (!text) return '';
            return text.replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n');
        }
        
        // =================================================================
        // START APP
        // =================================================================
        
        init();
    </script>
    
</body>
</html>
