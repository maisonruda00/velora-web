<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Velora Concierge</title>
    
    <!-- PWA Configuration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Velora">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3175/3175199.png">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=Inter:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #0a0a0a; color: #e5e5e5; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .gold-text { color: #D4AF37; }
        .gold-border { border: 1px solid #D4AF37; }
        .step-panel.hidden { display: none; }
        
        /* Luxury Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0a0a0a; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #D4AF37; }
        
        /* Fade Animation */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="min-h-screen selection:bg-[#D4AF37] selection:text-black">

    <div id="wizard" class="max-w-md mx-auto min-h-screen relative p-6 border-x border-gray-900/50">
        
        <!-- Step 0: Login (Velvet Rope) -->
        <div id="step-login" class="step-panel flex flex-col justify-center h-screen items-center px-8 bg-black">
            <h1 class="font-serif text-5xl gold-text italic tracking-wide mb-4">Velora</h1>
            <p class="text-xs uppercase tracking-[0.3em] text-gray-600 mb-16">Private Cellar</p>
            
            <div class="w-full max-w-xs space-y-8">
                <input type="password" id="accessCode" placeholder="ENTER ACCESS KEY" 
                       autocomplete="off"
                       class="w-full bg-transparent border-b border-[#D4AF37] text-center text-white py-4 text-xl tracking-[0.2em] focus:outline-none placeholder-gray-800 uppercase">
                
                <button onclick="attemptLogin()" class="w-full py-4 border border-[#D4AF37] text-[#D4AF37] uppercase tracking-widest text-xs hover:bg-[#D4AF37] hover:text-black transition-colors">
                    Enter Cellar
                </button>
                
                <p class="text-center text-xs text-gray-700 mt-8">Invitation Only</p>
            </div>
        </div>
        
        <!-- Step 1: Loading Screen (Wine Quotes) -->
        <div id="step-context" class="step-panel hidden flex flex-col justify-center h-screen items-center text-center px-6">
            <h1 class="font-serif text-4xl gold-text italic tracking-wide mb-8">Velora</h1>
            <p id="loading-quote" class="text-sm font-serif text-gray-400 italic leading-relaxed min-h-[60px] max-w-sm fade-in">
                "Wine is sunlight, held together by water."
            </p>
            <p class="text-[10px] uppercase tracking-[0.3em] text-gray-600 mt-8 animate-pulse">Consulting Cellar...</p>
        </div>
        
        <!-- Step 2: Menu Selection (Categorized) -->
        <div id="step-menu" class="step-panel hidden pt-12 pb-32">
            <h1 class="font-serif text-3xl text-white mb-2">The Menu</h1>
            <p class="text-gray-500 text-sm mb-8">Select dishes for the table.</p>
            
            <div id="menuGrid" class="space-y-8 mb-16">
                <!-- Populated by JS -->
            </div>
            
            <div class="fixed bottom-0 left-0 w-full bg-gradient-to-t from-black via-black to-transparent p-6 text-center pointer-events-none">
                 <button onclick="nextStep('step-constraints')" class="pointer-events-auto bg-[#D4AF37] text-black px-12 py-4 rounded-sm font-serif font-bold uppercase tracking-widest text-xs hover:bg-white transition-colors shadow-lg shadow-[#D4AF37]/20">
                    Proceed to Cellar
                </button>
            </div>
        </div>

        <!-- Step 3: Budget Constraints -->
        <div id="step-constraints" class="step-panel hidden pt-12">
            <h1 class="font-serif text-3xl text-white mb-12">Acquisition</h1>
            
            <div class="mb-12">
                <label class="block text-xs uppercase tracking-widest text-gray-500 mb-6">Total Budget</label>
                <div class="text-5xl font-serif text-white mb-6">$<span id="budgetDisplay">1000</span></div>
                <input type="range" id="budgetRange" min="200" max="5000" step="100" value="1000" oninput="updateBudget()"
                       class="w-full h-1 bg-gray-800 rounded-lg appearance-none cursor-pointer accent-[#D4AF37]">
                <div class="flex justify-between text-[10px] uppercase tracking-widest text-gray-600 mt-4">
                    <span>Premier</span>
                    <span>Grand Cru</span>
                    <span>Iconic</span>
                </div>
            </div>

            <button onclick="consultSommelier()" id="generateBtn" class="w-full bg-[#D4AF37] text-black py-4 font-serif font-bold uppercase tracking-widest text-xs hover:bg-white transition-colors mt-8">
                Generate Progression
            </button>
        </div>

        <!-- Step 4: Results -->
        <div id="step-results" class="step-panel hidden pt-8">
            <div class="flex justify-between items-end mb-8 border-b border-gray-900 pb-4">
                <h1 class="font-serif text-2xl text-white">Recommendation</h1>
                <span class="text-[#D4AF37] text-sm font-serif italic" id="totalCostDisplay">$0</span>
            </div>
            
            <div id="resultsGrid" class="space-y-12">
                <!-- Populated by JS -->
            </div>
            
            <button onclick="location.reload()" class="w-full mt-12 mb-8 py-4 border border-[#D4AF37] text-[#D4AF37] uppercase tracking-widest text-xs hover:bg-[#D4AF37] hover:text-black transition-colors">
                Close Consultation
            </button>
        </div>

    </div>

    <script>
        // =================================================================
        // DATA - Categorized Menu (Gemini's improvement)
        // =================================================================
        const MENU_CATEGORIES = {
            "Antipasti": [
                "Carpaccio Piemontese",
                "Burrata & Heirloom Tomato",
                "Caesar Salad",
                "Oysters on the Half Shell"
            ],
            "Primi": [
                "Spicy Rigatoni Vodka",
                "Truffle Gnocchi",
                "Lobster Ravioli",
                "Pappardelle Bolognese"
            ],
            "Secondi": [
                "Veal Parmesan",
                "Dover Sole",
                "Ribeye Steak",
                "Rack of Lamb",
                "Duck Breast"
            ],
            "Dolce": [
                "Tiramisu",
                "Lemon Cheesecake",
                "Chocolate Fondant"
            ]
        };

        // Wine Quotes for Loading Screen (Gemini's improvement)
        const WINE_QUOTES = [
            "\"Wine is sunlight, held together by water.\" ‚Äî Galileo",
            "\"A meal without wine is like a day without sunshine.\" ‚Äî Brillat-Savarin",
            "\"Age is just a number. It's totally irrelevant unless, of course, you happen to be a bottle of wine.\" ‚Äî Joan Collins",
            "\"Accept what life offers you and try to drink from every cup. All wines should be tasted.\" ‚Äî Paulo Coelho",
            "\"Wine is the most healthful and most hygienic of beverages.\" ‚Äî Louis Pasteur"
        ];

        let state = { selectedDishes: [], budget: 1000 };
        let quoteInterval;

        // =================================================================
        // GPS LOCATION LOGIC
        // =================================================================
        let userLocation = null;
        
        function checkLocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        console.log("üìç Location acquired:", userLocation);
                    },
                    (error) => {
                        console.warn("üìç GPS denied or unavailable:", error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    }
                );
            }
        }
        
        // =================================================================
        // AUTH & SESSION LOGIC (VELVET ROPE)
        // =================================================================
        
        function attemptLogin() {
            const code = document.getElementById('accessCode').value.trim().toUpperCase();
            
            if (!code) {
                showLoginError("Please enter an access key");
                return;
            }
            
            const btn = document.querySelector('#step-login button');
            const originalText = btn.innerHTML;
            btn.innerHTML = "<span class='animate-pulse'>Verifying...</span>";
            btn.disabled = true;
            
            // Call backend API
            fetch('/login', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({code: code})
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === "success" || data.success === true) {
                    localStorage.setItem('velora_token', code);
                    localStorage.setItem('velora_user_id', data.user_id || 'unknown');
                    localStorage.setItem('velora_login_time', new Date().toISOString());
                    
                    initMenu();
                    nextStep('step-menu');
                    checkLocation();
                } else {
                    showLoginError("Invalid Access Code. Invitation Required.");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    document.getElementById('accessCode').value = '';
                }
            })
            .catch((error) => {
                console.warn('API unavailable, using offline validation:', error);
                
                const validCodes = ['MEMBER_2025', 'GENESIS_KEY', 'GENESIS'];
                
                if (validCodes.includes(code)) {
                    localStorage.setItem('velora_token', code);
                    localStorage.setItem('velora_login_time', new Date().toISOString());
                    
                    initMenu();
                    nextStep('step-menu');
                    checkLocation();
                } else {
                    showLoginError("Invalid Access Code. Invitation Required.");
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    document.getElementById('accessCode').value = '';
                }
            });
        }
        
        function showLoginError(message) {
            const input = document.getElementById('accessCode');
            input.classList.add('border-red-500');
            input.placeholder = message;
            
            setTimeout(() => {
                input.classList.remove('border-red-500');
                input.placeholder = "ENTER ACCESS KEY";
            }, 3000);
        }
        
        // Allow Enter key to submit login
        document.addEventListener('DOMContentLoaded', function() {
            const accessInput = document.getElementById('accessCode');
            if (accessInput) {
                accessInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        attemptLogin();
                    }
                });
            }
        });
        
        // =================================================================
        // LOADING SCREEN WITH WINE QUOTES (Gemini's improvement)
        // =================================================================
        
        function startQuoteCycle() {
            let i = 0;
            const el = document.getElementById('loading-quote');
            el.innerText = WINE_QUOTES[0];
            
            quoteInterval = setInterval(() => {
                i = (i + 1) % WINE_QUOTES.length;
                el.classList.remove('fade-in');
                setTimeout(() => {
                    el.innerText = WINE_QUOTES[i];
                    el.classList.add('fade-in');
                }, 100);
            }, 4000);
        }

        function stopQuoteCycle() {
            if (quoteInterval) {
                clearInterval(quoteInterval);
            }
        }
        
        // =================================================================
        // NAVIGATION
        // =================================================================
        
        function nextStep(stepId) {
            document.querySelectorAll('.step-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById(stepId).classList.remove('hidden');
            window.scrollTo(0,0);
        }

        // =================================================================
        // MENU LOGIC (Gemini's categorized approach)
        // =================================================================
        
        function initMenu() {
            const grid = document.getElementById('menuGrid');
            let html = '';
            
            for (const [category, dishes] of Object.entries(MENU_CATEGORIES)) {
                html += `
                    <div class="mb-6">
                        <h3 class="text-xs font-bold uppercase tracking-widest text-[#D4AF37] mb-4 border-b border-gray-800 pb-2">
                            ${category}
                        </h3>
                `;
                
                dishes.forEach(dish => {
                    html += `
                        <div class="flex justify-between items-center py-3 cursor-pointer group transition-all" 
                             onclick="toggleDish(this, '${dish}')">
                            <span class="font-serif text-lg text-gray-400 group-hover:text-white transition-colors">
                                ${dish}
                            </span>
                            <div class="w-3 h-3 border border-gray-600 rounded-full indicator transition-all"></div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            grid.innerHTML = html;
        }

        function toggleDish(el, name) {
            const indicator = el.querySelector('.indicator');
            
            if (state.selectedDishes.includes(name)) {
                state.selectedDishes = state.selectedDishes.filter(d => d !== name);
                indicator.classList.remove('bg-[#D4AF37]', 'border-transparent');
                indicator.classList.add('border-gray-600');
            } else {
                state.selectedDishes.push(name);
                indicator.classList.remove('border-gray-600');
                indicator.classList.add('bg-[#D4AF37]', 'border-transparent');
            }
        }

        function updateBudget() {
            const value = document.getElementById('budgetRange').value;
            document.getElementById('budgetDisplay').innerText = value;
            state.budget = parseInt(value);
        }

        // =================================================================
        // üß† THE BRAIN - REAL API CALL TO PAIRING ENGINE
        // Claude's sophisticated algorithm with Gemini's UX improvements
        // =================================================================
        
        async function consultSommelier() {
            const btn = document.getElementById('generateBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = "<span class='animate-pulse'>Accessing Cellar...</span>";
            btn.disabled = true;
            
            // Show loading screen with cycling quotes
            nextStep('step-context');
            startQuoteCycle();
            
            // Get selected dishes
            const dishes = state.selectedDishes;
            const mainDish = dishes[0] || "Ribeye Steak";
            const budget = state.budget;
            
            try {
                // 15-second timeout (Gemini's improvement, extended slightly)
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                
                // CALL REAL BACKEND API
                const response = await fetch('https://velora.vin/consult', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        dish: mainDish,
                        budget: budget
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }
                
                const data = await response.json();
                
                stopQuoteCycle();
                
                if (data.success) {
                    // Use REAL recommendation from pairing engine
                    renderResults(data);
                    nextStep('step-results');
                } else {
                    alert('The cellar is currently restricted for this selection. Please adjust your budget or dish.');
                    nextStep('step-constraints');
                }
                
            } catch (error) {
                stopQuoteCycle();
                
                if (error.name === 'AbortError') {
                    console.error('Request timeout after 15 seconds');
                    alert('Connection timeout. The cellar took too long to respond. Please try again.');
                } else {
                    console.error('Pairing API error:', error);
                    alert('Unable to connect to the cellar. Please check your connection and try again.');
                }
                
                nextStep('step-constraints');
                
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // =================================================================
        // RESULTS RENDERING
        // =================================================================
        
        function renderResults(data) {
            const grid = document.getElementById('resultsGrid');
            const wine = data.recommendation;
            const reasoning = data.reasoning;
            
            // Display total cost
            document.getElementById('totalCostDisplay').innerText = `$${wine.price}`;
            
            // Render wine recommendation with chemistry reasoning
            grid.innerHTML = `
                <div class="relative pl-8 border-l-2 border-[#D4AF37]">
                    <div class="absolute -left-[5px] top-0 w-2 h-2 rounded-full bg-[#D4AF37]"></div>
                    
                    <p class="text-[10px] uppercase tracking-widest text-gray-500 mb-2">Selection</p>
                    
                    <h3 class="font-serif text-2xl text-white mb-1">${wine.wine_name}</h3>
                    <p class="text-sm text-gray-400 mb-4">${wine.producer}</p>
                    
                    <div class="mb-4">
                        <p class="text-xs uppercase tracking-widest text-gray-600 mb-2">Chemistry</p>
                        ${reasoning.chemistry.map(c => `
                            <p class="text-gray-400 text-sm mb-1">‚Ä¢ ${c}</p>
                        `).join('')}
                    </div>
                    
                    <p class="text-gray-300 italic text-sm leading-relaxed border-l-2 border-[#D4AF37]/30 pl-4 mb-4">
                        "${reasoning.why}"
                    </p>
                    
                    <div class="flex justify-between items-center pt-4 border-t border-gray-800">
                        <span class="text-xs uppercase tracking-widest text-gray-500">${wine.type}</span>
                        <p class="text-right text-[#D4AF37] font-serif text-xl">$${wine.price}</p>
                    </div>
                </div>
            `;
        }

        // =================================================================
        // INITIALIZATION
        // =================================================================
        
        // Check for existing session on page load
        function checkSession() {
            const token = localStorage.getItem('velora_token');
            
            if (token) {
                console.log("‚úÖ Valid session found");
                document.getElementById('step-login').classList.add('hidden');
                initMenu();
                nextStep('step-menu');
                checkLocation();
            } else {
                console.log("üîí No session - showing login");
                document.getElementById('step-login').classList.remove('hidden');
            }
        }
        
        // Auto-check session on page load
        checkSession();
    </script>
</body>
</html>
